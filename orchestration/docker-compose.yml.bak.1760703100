
x-airflow-common: &airflow-common
  image: airflow-dbt:latest
  environment:
    AIRFLOW__CORE__EXECUTOR: SequentialExecutor
    AIRFLOW__CORE__LOAD_EXAMPLES: "False"
    AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "True"
    AIRFLOW__SCHEDULER__ENABLE_HEALTH_CHECK: "True"
    AIRFLOW__CORE__DEFAULT_TIMEZONE: "Europe/Paris"
    _AIRFLOW_WWW_USER_USERNAME: admin
    _AIRFLOW_WWW_USER_PASSWORD: admin
    AIRFLOW_UID: "50000"
  volumes:
    # DAGS
    - ../dags:/opt/airflow/dags
    # Monte la racine du repo pour accéder à course/airbnb
    - ..:/opt/airflow/repo
    # Logs/Plugins Airflow
    - airflow_logs:/opt/airflow/logs
    - airflow_plugins:/opt/airflow/plugins
  user: "50000:0"

services:
  airflow-init:
    <<: *airflow-common
    command: >
      bash -c "
      airflow db init &&
      airflow users create
        -u admin -p admin -r Admin
        -e admin@example.com -f Admin -l User || true
      "

  webserver:
    <<: *airflow-common
    command: webserver
    ports: ["8081:8080"]
    depends_on: [scheduler]

  scheduler:
    <<: *airflow-common
    command: scheduler
    depends_on: [airflow-init]

volumes:
  airflow_logs:
  airflow_plugins:
